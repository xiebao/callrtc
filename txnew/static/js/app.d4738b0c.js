(function(e){function t(t){for(var s,a,r=t[0],c=t[1],d=t[2],h=0,m=[];h<r.length;h++)a=r[h],Object.prototype.hasOwnProperty.call(i,a)&&i[a]&&m.push(i[a][0]),i[a]=0;for(s in c)Object.prototype.hasOwnProperty.call(c,s)&&(e[s]=c[s]);l&&l(t);while(m.length)m.shift()();return o.push.apply(o,d||[]),n()}function n(){for(var e,t=0;t<o.length;t++){for(var n=o[t],s=!0,r=1;r<n.length;r++){var c=n[r];0!==i[c]&&(s=!1)}s&&(o.splice(t--,1),e=a(a.s=n[0]))}return e}var s={},i={app:0},o=[];function a(t){if(s[t])return s[t].exports;var n=s[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=s,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(n,s,function(t){return e[t]}.bind(null,s));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="./";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],c=r.push.bind(r);r.push=t,r=r.slice();for(var d=0;d<r.length;d++)t(r[d]);var l=c;o.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("56d7")},"034f":function(e,t,n){"use strict";n("85ec")},2842:function(e,t,n){e.exports=n.p+"static/img/ic_video_photo.e8920b9c.png"},"4bf8":function(e,t,n){},"4e29":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAMAAAAL34HQAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAg1QTFRFAAAA////////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdHR0jIyMhYWFgoKCgICAf39/Ojo6AAAAAAAAAAAANDQ01tbW+vr69PT0sbGxAAAAd3d39vb23NzcAAAAAAAAAAAA7e3t1dXVAAAAAAAAAAAAtbW1XFxcAAAAAAAA6enpuLi4AAAAAAAA9fX1xMTEAAAAAAAAvr6+AAAAAAAA1tbW8PDwurq6AAAAubm5AAAAAAAAAAAA29vb+/v7//n5/6ur/2xs/zw8/xoa/wAAgICA/9ra/2tr/wkJtLS0AAAAAAAAAAAAoqKiAAAA/3x8kZGR/97e/z4+r6+vAAAAAAAAXFxc+Pj4/8/P/x0dJCQk8fHx/+Li/yAgq6urAAAAHx8f5ubm/0hIxsbG/5eXqKiot7e3/yMj2dnZ/7Gx/2lp/zMz/wcHw8PDycnJMjIy8PDwQ0ND3t7ex8fHw8PDtra2wsLCW1tbNjY28/Pz1NTUAAAA8PDwQEBAWlpa3t7e+fn5x8fHAAAAh4eHkZGRAAAAAAAAAAAAAAAAQxn3zQAAAK90Uk5TADBAYIC/j3AQr8//31Ag758BAgMEBQgKDA0OEhcbHR4fGiMrMDQ1NgktOkZOUlVWE2l0en2AgEYHD0NPvvTpigZm6LkVJz/fq0AqEIdYL0rSmyYL6KYzUaxBMZjMbVSwTUVEufP///////9f////tVxXWJcu/4z//7praYX2//9y7P//v3mB5v/N/8LI/+H/////0LZR3D2le6eck1pL6qxC3UBbyfWjR3hxFEsoFqsfVrYAAAhTSURBVHic7Zzpn9NEGMdpmqRp0zRZe293e2y73XtZ94AFr1VZVNBVWa0uonIfERAUBFFBORRB5PC+7wMX+BudSbY0ZWcmmSRTeNHfq37aNPlm5plnjueZWbGirbbaaqute0MBLsjzvGBI5PkQx91lIInjwxEZoajAK7G7g6SIS0SqIIDSUjgo8CEsRJfYtGCL0aRg2HhyRAtxEuJ3LigK5gWh1pEpBlNUVFBEDXG8UZyRIPkyfyTxUeelEDNKVdVYF1lMg48RAxT/CMHXEFi2TgMqEqT9GxdmCSbxru9uvE+YSVUGVS+vbIDxvht/ADT4qOL5Dj7XZAi+q9ebKKC8RR8LLAZeVPDBMiQRFBhFKyYLvKUa8udWHCgwn24FGmDEt1eUgLMI+1CREmhCmp8tCJhpxLNBSBHfSr0uUJGqx9IPRGTVd/fs+aYB7y+GEqwC6i6sIUDln7FbJQkeuCAVq7ESaEgu+wxQ1MyoIJc78wBUKsPhG7y9G64wE2tvCHBF6SsDdF+M53uSKgu0/1E8NWFnAk1KpPtHTJU1NixWBWmbI2iEjFCapNG1Kp5pI2wImD2FeQV87559eVJEDjNEaRJFvbSqCg05LgLgT1pUhVABp/5Ra00rbDwu6uSyGHP33ixQOU4ct0Busx2Usn8g76S4OFkm2rv/WFLUQXFp2F4HPuQ+oHg8AZS0EbwmHofX28IF7Ysrhi8sZlgOrEvDWRZEiseTyVQqnc5kstlOG2WzmUw6nUolkxCODMbbtX0AjmmGLLEku8aPq2YIlUikUtlsLtfV1d2dzxcKRYIKhXy+u7urK5fLZlOpRMIGDG/QpiIYB88YC7h60vg5hv4ZQiWT6XQuVyr19JTLlUpvb7XaR1C12ttbqZTLPT2lUi6XTieTpunjzJ/sI0LofpM9FubBS4qgoTs6Eon+/lyuWBwYGBwcGhoeHhkZHV1J0OjoyMjw8NDQ4ODAQLE4NgbBTHeBdhiYaiL/2Ix1//jExOTk1NQqgqamJicnJsbHVzvEwhWIoRDSacEqnJ5esyafr1TWPvDgQ6iQGFYPP7K2UikUYEWmUtPTMzOmk10GxhPaYhjZDq1Yjz5GBQX1uCOsgKxisVQZNY/u6IjH+/vXrZudXb/+CWoqWX7yqQ0burvHxjYCdXam0zMz8fjyakQ/m0BswXraBZUsP+MEC11TUFj3kEhkMqXS3Nyzz7nCer5a3bQJuthCAbqL+XnTXTQ/BW9cGjoiYMF6wRXWi06wOOzoJoLuMCFWNpvP12ovuaKSX15YgM61Utm8uVzO53O5VApRjbKMwSJ4LX+wXtnyKh4rihlFxDBttKMjmezsLBSq1dfcYb2+deu2bdu3b9shyzsHZ2e7uubnE4llWALGoXKYEaAt1q7de/bu03V93949u3fhsXbAz29gsXhMrAvXXZpYxWJf30oU1P4DB/WGDh7Yv+yKNw8dOnz4rbeNz+NHjnR3Z7MILNzjcbhkrKP6nTqKxHpHtsHCVZboAuvY8WVUun78WPNF75448d77H5ifJ2q1fL6zM5lEYKEH9AKmKRCwTp5CUOn6qZN3Yn34kWyHJWE8BD3W6TNIKl0/c9p62dlzH39S/zxZrRYKSCyc46LHOo+h0vXzzVifyi3EuoCl0vULlusuftb4PNXXVyyyxbpEwLpkue5zuZVYlwlUun5ZRoo91hUi1pW7hXWViHUVjbWKOdY1Ita1u4VFpNJ1/yoRPbLwtbTwWLi5D21X7di2nDkIXFdNi+W4JV78wgmWgsHCfe/Zb509d7tLJHQ+PCa4iBtZePbyzrpqzLwLO7Lw3CeCgU19uEUY2OAcAW6+7XkEYQwDbbGwS9wYD+F5vGUMms2hPH7QHMPOEzFG53l0ak4xviRj4Roc/AVp86QJmaOxvKMJmYiN8ku4BV3SPNHBzGcJ66uvSdPXCD7Ij/7JZrJvP0+sT/a/+XbLd7jJPqZICAVpuwZhN6t2sjQSJMRXFORijmUhiW7dtK7v+/psF5I0UgKJjPJcnpfdfnCAhV+jXAFXChHMlkXKH11h/VQu2y1SouupLmQkyoL18y8uqH79zR6LWIfouF3TAvhOaqrf/6gVizYL4BKxDtERtKZwwZ9/0UH9/c+/NXssu7Awh3QfTcGV1eMOgitmeOX69f8WarWensVFaOaE4AouXmi5ADHqoQ9FmcGoGzcWHGGhC8MqjNHTBu5g6K5Wm5u7ebNQWFzMZMiBu7B9Dhsqys4Yi5BNcFvoHA7aoLAZFi6Vbt3auNEM2hGCwthsAovQSQkssZzlJPHodFDahIN6ysH0tBlAx2PZJPUsSYoipyDMsOySeuoKYpLd6JJZGuksNsksUaeppJhSZYPFy6rDFOIAKUuVNlHKJu0nRpHxJxLewGcsZ/ZuClh9izI86ZI2W5UPS/scHjl89lugVihT0wU3Ofa0Ehy3wrpAH8Q8+1R0USUB5hnzQVc7BcC/KHP/6aTI7t7b3ds4lfva0BhyednaxI7L24YrjZFbVTxuA9Nc2iVZwGo9bgPj/dkTeuc9Pe8PDfq58xUK7n71oQbgnlBP+7ybFfC2ZbKhWMTHXdoh1b9dq6Jf29qNfeP+mapP29pBUXnfYm8VtNOoR5PgIn63HiAl6u2oCXjyguprUZnycEoF03MqzHu7AXP9R5r7054AowhsoaDMo1k0x/41IMKDWcLs91lJxgkwgMy+zDiDSRVbtH+P01S4iizwyJOIlq4JhY2Lwj52XPZSRPOApmiYD3JNpSFxCq+ZpzqpWksOImpWLKg1TrmKmudvWb4Ih1owAcaJC/GC0BwhiAgiqXZbKm5J9whOW2211VZb97L+By4gNL+QIhqbAAAAAElFTkSuQmCC"},"56d7":function(e,t,n){"use strict";n.r(t);n("e260"),n("e6cf"),n("cca6"),n("a79d");var s=n("a026"),i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"app"}},[e.listenshow?n("HelloWorld",{attrs:{msg:"Welcome to WanLuo call App"}}):n("Start",{attrs:{msg:"login"}})],1)},o=[],a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("article",[s("div",{staticClass:"divcontxt"},[s("p",[e._v(" 呼叫:"+e._s(1==this.$store.state.actype?this.$store.state.callinfo.roomtel:this.$store.state.callinfo.doorname)+" ")]),s("p",{staticStyle:{color:"red"}},[s("b",[e._v(e._s(e.initstate))])]),s("p",{attrs:{id:"calltimer"}})]),s("div",{staticClass:"divhead",attrs:{id:"videos"}},[!1===e.ifHaveVideo?s("audio",{ref:"remoteVideo",staticStyle:{"object-fit":"fill"},attrs:{id:"remoteVideo",muted:"true",preload:"auto",autoplay:"autoplay","x-webkit-airplay":"true",playsinline:"true","webkit-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"true","x5-video-orientation":"portraint"}}):s("video",{ref:"remoteVideo",staticStyle:{"object-fit":"fill"},attrs:{id:"remoteVideo",muted:"true",preload:"auto",autoplay:"autoplay","x-webkit-airplay":"true",playsinline:"true","webkit-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"true","x5-video-orientation":"portraint"},domProps:{muted:!0}}),s("div",{staticClass:"arc",attrs:{id:"loading"}}),s("canvas",{attrs:{id:"canvas"}})]),s("div",{staticClass:"divcontrol"},[s("div"),s("div",{staticClass:"divctrl"},[s("div",{staticClass:"wpbutton",on:{click:function(t){return e.hangup()}}},[s("img",{staticClass:"imgbt",attrs:{src:n("57b9")}})])])])])},r=[],c=(n("2b3d"),n("2842")),d=n.n(c),l=n("c5d3"),h=n.n(l),m=n("4e29"),u=n.n(m),g=n("a92e"),p=n.n(g),v=n("ce44"),A=n.n(v),f=n("cf7d"),y=n.n(f),C=n("5883"),w=n.n(C);const b=n("bc3a");var k={name:"HelloWorld",props:{msg:String},data(){return{imgsrcscan:d.a,imgsrcrecord:h.a,imgsrcspeek:A.a,imgsrcaudio:y.a,IsLocalDataChannel:!0,isAndroid:!1,isIos:!1,isChrome:!1,isWeixin:!1,websock:null,showVideo:!0,connected:!1,connecting:!1,videoplaying:!1,socketTask:!1,startRecive:!1,StartCalled:!1,CheckedgetUserMedia:!1,IsWebSocketCreateed:!1,IsWebSocketConnecting:!1,IsWebSocketOpened:!1,IsLocalAudioTrack:!1,IsLocalVideoTrack:!1,IsSystemAudioDeviceOK:!1,IsFailCreate:!1,recorded:!1,speak:!1,mute:!1,myPeerConnection:null,myDataChannel:null,stream:null,remoteMediaStream:null,mediaRecorder:null,remoteVideo:null,heartCheck:null,messagecallback:null,RTCPeerConnectionCreated:!1,peerid:"",meid:"",device_id:"",calltime:null,sessionId:"",wsurl:"",url:"",mymsg:!1,roomId:"",IsReconnect:!1,timeout:2e3,timedelay:0,serverTimeoutObj:null,canAddIceCandidate:!1,IceCandidate:new Array,connectmode:"live",connectsource:"MainStream",configuration:{iceServers:[{urls:["stun:webrtc.qq-kan.com:3478?transport=udp"]}]},ifHaveVideo:!0}},created(){this.ifHaveVideo=this.$store.state.callinfo.isvideo,this.calltime=this.getQueryString("time");var e=this.getQueryString("topeer");if(null!=e){this.peerid=e,this.sessionId=this.newGuid();var t=this.getQueryString("mypeer");if(null!=t){this.meid=t;var n=this.getQueryString("device_id");null!=n&&(this.device_id=n),this.checktimesign()&&(this.initWebSocket(),this.NewgetUserMedia({video:1==this.$store.state.ability,audio:!0},this.streamHandler,this.errorHandler),this.timerstart())}else alert("参数错误")}else alert("目标错误")},mounted(){var e=document.getElementById("videos"),t=document.getElementById("canvas"),n=document.getElementById("loading");t.style.display="none",document.title="WebRTC-设备端";var s=this.getQueryString("doorname");null!=s&&(document.title=s);var i=window.navigator.userAgent;if(null!=i&&(this.isAndroid=i.indexOf("Android")>-1||i.indexOf("Linux")>-1,this.isIos=!!i.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),this.isChrome=-1!==i.indexOf("Chrome"),this.isWeixin=-1!=i.indexOf("micromessenger")),this.isIos||this.isAndroid)e.style.width="100%",n.style.left=Math.floor(document.documentElement.clientWidth/2-25)+"px",n.style.top=Math.floor(9*document.documentElement.clientWidth/16/2-25)+"px";else{e.style.width="100%";Math.floor(9*document.documentElement.clientWidth/16);document.documentElement.clientHeight,n.style.left=Math.floor(document.documentElement.clientWidth/2-25)+"px"}n.style.top="45vh",this.remoteVideo=document.getElementById("remoteVideo"),null!=this.remoteVideo&&(this.remoteVideo.muted=!0,this.remoteVideo.addEventListener("playing",this.OnVideoPlaying),this.remoteVideo.addEventListener("play",this.OnVideoPlay),this.remoteVideo.addEventListener("loadedmetadata",this.OnVideoLoadedMetaData),this.remoteVideo.addEventListener("canplay",this.OnVideoCanPlay),this.remoteVideo.addEventListener("error",this.OnVideoError),this.remoteVideo.addEventListener("loadeddata",this.OnVideoLoadedData),1==this.isWeixin&&0==this.isIos?console.log("Your browser Weixin  no ios"):1==this.isWeixin&&1==this.isIos?(console.log("Your browser Weixin addEventListener WeixinJSBridgeReady"),document.addEventListener("WeixinJSBridgeReady",(function(){var e=this;if(0==this.videoplaying){this.videoplaying=!0;var t=this.remoteVideo.play();t&&t.then(()=>{e.videoplaying=!0,console.log("browser Weixin <video> play.")}).catch(t=>{e.videoplaying=!1,console.log("<video> play error ",t.message)})}}),!1)):1==this.isChrome&&0==this.isIos?console.log("Your browser isChrome  no ios"):console.log("Your browser isChrome   ios"));let o=this;window.onresize=()=>{o.pageResize()}},computed:{initstate(){return this.$store.state.statename}},destroyed(){window.onresize=null,null!=this.websock&&this.websock.close(),null==this.stream&&this.$store.state.isclose||this.hangup()},methods:{getQueryVariable(e){for(var t=window.location.search.substring(1),n=t.split("&"),s=0;s<n.length;s++){var i=n[s].split("=");if(i[0]==e)return i[1]}return!1},hangup(){console.log("hangup"),this.PostMessage("handup"),this.PostMessage("hangup"),this.$store.state.login=!1,this.$store.state.isclose=!0,this.posesynclose(),this.sendDisconnect(),this.handleLeave(),this.timerreset(),this.close(),null!=this.stream&&(this.stream.getTracks().forEach(e=>{e.stop()}),window.localStream=null,this.stream=null),null!=this.websock&&(this.websock.close(),this.websock=null)},posesynclose(){var e={cmd:"hangup",session:this.sessionId,licence:this.meid,phone:this.peerid,et:this.device_id,ty:1};null!=this.stream&&b({method:"post",url:"wechat/sync",baseURL:this.$store.state.callinfo.remoteurl,headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json",token:this.$store.state.accesstoken},data:e,params:e}).then(t=>{console.log("wechat/sync",e,t.data)}).catch(e=>{console.log(e)})},wpvideocall(){var e={licence:this.$store.state.callinfo.meid,phone:this.$store.state.callinfo.phone,et:this.$store.state.deviceId,sessionId:this.sessionId};console.log(e);var t="/wechat/confirm";b({method:"post",url:t,baseURL:this.$store.state.callinfo.remoteurl,headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json",token:this.$store.state.accesstoken},data:e,params:e}).then(e=>{if(console.log("--/wechat/confirm--",e.data),200==e.data.retCode){var t=this,n=document.getElementById("calltimer");t.$store.state.statename="呼叫中";var s=60*t.$store.state.talkTime;if(s>0)var i=setInterval((function(){s--,t.$store.state.isclose?clearInterval(i):s<=0?(clearInterval(i),t.$store.state.statename="呼叫失败",t.hangup()):n.innerHTML=s+"秒后结束"}),1e3)}else alert(e.data.message)}).catch(e=>{console.log(e)})},checktimesign(){var e=(new Date).valueOf();return!(null==this.calltime||e-+this.calltime>45e3)},webrtcrecord(){1==this.videoplaying?this.recorded?(this.stoprecord(),this.imgsrcrecord=h.a):(this.startrecord(),this.imgsrcrecord=u.a):this.imgsrcrecord=h.a},setlocalspeak(){if(null!=this.myPeerConnection){this.speak=!this.speak,1==this.speak?this.imgsrcspeek=p.a:this.imgsrcspeek=A.a,null!=this.remoteVideo&&1==this.remoteVideo.muted&&(this.remoteVideo.muted=!1);var e=this;this.myPeerConnection.getReceivers().forEach((function(t){null!=t.track&&"audio"===t.track.kind&&(t.track.enabled=e.speak,console.log("PeerConnection  setlocalspeak    -------------------------------------- ",t))}))}},setlocalaudio(){if(null!=this.myPeerConnection){this.mute=!this.mute,1==this.mute?this.imgsrcaudio=w.a:this.imgsrcaudio=y.a;var e=this;this.myPeerConnection.getSenders().forEach((function(t){null!=t.track&&"audio"===t.track.kind&&(t.track.enabled=e.mute,console.log("PeerConnection  setlocalaudio    -------------------------------------- ",t))}))}},startrecord(){var e=this;null!=this.remoteMediaStream&&(this.mediaRecorder=new MediaRecorder(this.remoteMediaStream),null!=this.mediaRecorder&&(this.recorded=!0,this.mediaRecorder.blobs=[],this.mediaRecorder.ondataavailable=function(t){e.mediaRecorder.blobs.push(t.data)},this.mediaRecorder.onstop=function(t){if("stop"==t.type&&e.mediaRecorder.blobs.length){var n=new Blob(e.mediaRecorder.blobs,{type:e.mediaRecorder.mimeType}),s=window.URL.createObjectURL(n),i=document.createElement("a");i.style.display="none",i.href=s,i.download=(new Date).valueOf()+"a.webm";var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(o),URL.revokeObjectURL(s)}},this.mediaRecorder.start()))},stoprecord(){1==this.recorded&&null!=this.remoteMediaStream&&null!=this.mediaRecorder&&(this.mediaRecorder.stop(),this.recorded=!1)},scanpicture(){if(1==this.videoplaying){var e=document.getElementById("canvas"),t=document.getElementById("remoteVideo"),n=e.getContext("2d");n.drawImage(t,0,0,e.width,e.height);var s=e.toDataURL("image/png");console.log("PeerConnection  scanpicture    -------------------------------------- ",s)}},AndroidSaveVideoFile(e){window.AndroidWebView.SaveVideoFile(e)},pageResize(){var e=document.getElementById("videos"),t=document.getElementById("loading");if(this.isIos||this.isAndroid)e.style.width="100%",t.style.left=Math.floor(document.documentElement.clientWidth/2-25)+"px";else{e.style.width="100%";var n=Math.floor(9*document.documentElement.clientWidth/16);n>document.documentElement.clientHeight-60?(t.style.left=Math.floor(document.documentElement.clientWidth/2-25)+"px",t.style.top=Math.floor(e.style.height/2-25)+"px"):(t.style.left=Math.floor(document.documentElement.clientWidth/2-25)+"px",t.style.top=Math.floor(9*document.documentElement.clientWidth/16/2-25)+"px")}t.style.top="45vh"},timerreset(){clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj)},timerstart(){var e=this;this.serverTimeoutObj=setInterval((function(){e.timedelay++,e.websock&&1===e.websock.readyState?(1==e.IsReconnect?(console.log("reconnect  ------------------- "),1==e.RTCPeerConnectionCreated&&e.handleLeave(),e.StartCalled=!1,e.sessionId=e.newGuid()):e.timedelay>30&&(e.timedelay=0,e.sendToServer({eventName:"__ping",data:{sessionId:e.sessionId,sessionType:"IE",messageId:e.newGuid(),from:e.meid,to:e.peerid}})),e.timerreset(),e.timerstart()):0==e.IsWebSocketConnecting?(null!=e.websock&&(e.websock.close(),e.websock=null),1==e.RTCPeerConnectionCreated&&e.handleLeave(),e.initWebSocket()):console.log("IsWebSocketConnecting  ------------------- ")}),this.timeout)},initWebSocket(){if(this.$store.state.login&&""!=this.$store.state.callinfo.meid&&1!=this.IsWebSocketConnecting){var e="https:"==document.location.protocol;this.IsWebSocketConnecting=!0;var t="",n=this.getQueryString("server");null!=n&&""!=n||(n="rtcsv.yhxaiot.com"),t="localhost:8080"==n||""==n?e?"wss://webrtc.qq-kan.com/wsequipment/"+this.meid:"ws://webrtc.qq-kan.com/wsequipment/"+this.meid:e?"wss://"+n+"/wsequipment/"+this.meid:"ws://"+n+"/wsequipment/"+this.meid,console.log("initWebSocket --------",t),null!=this.websock&&(this.websock.close(),this.websock=null),this.websock=new WebSocket(t),this.websock.onmessage=this.websocketonmessage,this.websock.onopen=this.websocketonopen,this.websock.onerror=this.websocketonerror,this.websock.onclose=this.websocketclose}},websocketonopen(){var e=this;this.IsWebSocketOpened=!0,console.log("initWebSocket --------open！"),null!=this.websock&&1===this.websock.readyState?this.StartCalled=!1:setTimeout(()=>{null!=e.websock&&1===e.websock.readyState&&(e.StartCalled=!1)},100)},websocketonerror(e){this.IsWebSocketOpened=!1,this.IsWebSocketConnecting=!1,this.websock=null,console.log("连接错误",e)},websocketonmessage(e){const t=JSON.parse(e.data);switch(console.log("--<<<<<<<<<<<<<<<websocket- onmessage--:"+t.eventName),t.eventName){case"_call":this.handleCall(t.data);break;case"_create":this.handleCreate(t.data);break;case"_answer":this.$store.state.statename="接通中……",this.handleAnswner(t.data);break;case"_offer":this.$store.state.statename="接通中……",this.handleOffer(t.data);break;case"_ice_candidate":this.handleCandidate(t.data);break;case"_session_disconnected":case"_disconnected":this.$store.state.statename="挂机",this.hangup();break;case"_post_message":this.handlePostMessage(t.data);break;case"_connectinfo":case"_connectto":this.handleConnectInfo(t.data);break;case"_session_failed":this.handleSessionFailed(t.data);break;case"_ping":break;default:console.log("Got default message",t);break}},websocketsend(e){null!=this.websock&&1===this.websock.readyState&&this.websock.send(e)},websocketclose(e){this.IsWebSocketOpened=!1,this.IsWebSocketConnecting=!1,this.websock=null,console.log("断开连接",e)},getQueryString(e){switch(e){case"server":return this.$store.state.callinfo.server;case"mypeer":return this.$store.state.callinfo.meid;case"topeer":return this.$store.state.callinfo.peerid;case"doorname":return this.$store.state.callinfo.doorname;case"device_id":return this.$store.state.deviceId;case"time":return(new Date).valueOf();default:return""}},NewgetUserMedia(e,t,n){console.log("NewgetUserMedia----------------"),window.navigator.mediaDevices&&window.navigator.mediaDevices.getUserMedia?window.navigator.mediaDevices.getUserMedia(e).then(t).catch(n):window.navigator.webkitGetUserMedia?window.navigator.webkitGetUserMedia(e).then(t).catch(n):window.navigator.mozGetUserMedia?window.navagator.mozGetUserMedia(e).then(t).catch(n):window.navigator.getUserMedia?window.navigator.getUserMedia(e).then(t).catch(n):window.navigator.msGetUserMedia?window.navigator.msGetUserMedia(e).then(t).catch(n):(this.CheckedgetUserMedia=!1,this.IsLocalAudioTrack=!1,console.log("Your browser no getUserMedia function"))},Connect(){this.sendToServer({eventName:"__connectto",data:{sessionId:this.sessionId,sessionType:"IE",messageId:this.newGuid(),from:this.meid,to:this.peerid}})},handleDisconnect(e){e.sessionId==this.sessionId&&(console.log("handleDisconnect ",JSON.stringify(e)),1==this.RTCPeerConnectionCreated&&this.handleLeave())},sendToServer(e){console.log("------\x3e>>>>>>>>>websocket---send : ",e.eventName),this.websocketsend(JSON.stringify(e))},PostMessage(e,t){if(1==this.connected){var n=this.newGuid();this.messagecallback=t,this.sendToServer({eventName:"__post_message",data:{sessionId:this.sessionId,sessionType:"IE",messageId:n,to:this.peerid,from:this.meid,message:e}})}},handlePostMessage(e){if(void 0===this.messagecallback||null===this.messagecallback||("function"===typeof this.messagecallback&&this.messagecallback(e.message),this.messagecallback=null),"callon"==e.message&&(this.$store.state.statename="通话中",this.mute=!0,this.setlocalspeak()),"openDoor"==e.message){this.$store.state.statename="通话中",this.mute=!0,this.setlocalspeak();const e=document.getElementById("myWebview");e.contentWindow.postMessage({type:"callMethod",method:"sendBLEOpen"})}},handleSessionFailed(e){console.log("handleSessionFailed ",e),e.sessionId==this.sessionId&&(1==this.RTCPeerConnectionCreated&&(this.handleLeave(),this.sendDisconnect()),this.sessionId=this.newGuid())},handleCreate(e){console.log("WebSocket _create",e),"online"===e.state||"sleep"===e.state?(this.IsWebSocketCreateed=!0,null===e.iceServers&&void 0===e.iceServers&&""===e.iceServers||(e.iceServers.constructor===Object?(console.log(" _create  iceServers ---object ---- ",JSON.stringify(e.iceServers)),this.configuration=JSON.parse(JSON.stringify(e.iceServers))):(console.log(" _create  iceServers ---string ---- :",e.iceServers),this.configuration=JSON.parse(e.iceServers))),1==this.CheckedgetUserMedia&&0==this.StartCalled?(console.log("handleCreate  start call"),this.Call()):console.log("handleCreate  CheckedgetUserMedia =",this.CheckedgetUserMedia," StartCalled=",this.StartCalled)):console.log(" _create  offline  ",e.from)},Call(){this.StartCalled=!0;var e="sendrecv",t="sendrecv",n="true";0==this.IsLocalDataChannel&&(n="false"),0==this.IsLocalAudioTrack&&(e="recvonly"),0==this.IsLocalVideoTrack&&(t="recvonly"),console.log("call audio --------------",e," video ",t," datachannel",n)},handleConnectInfo(e){console.log("Got ConnectInfo Message:",e.message),this.sendToServer({eventName:"__pong",data:{sessionId:this.sessionId,sessionType:"IE",messageId:this.newGuid(),from:this.meid,to:this.peerid}})},handleLeave(){console.log("handleLeave  --------");var e=this;null!=this.myDataChannel&&(this.myDataChannel.close(),this.myDataChannel.onopen=null,this.myDataChannel.onclose=null,this.myDataChannel.onmessage=null,this.myDataChannel.onerror=null,this.myDataChannel=null),null!=this.myPeerConnection&&(console.log("handleLeave  --------signalingState = ",this.myPeerConnection.signalingState),"closed"==this.myPeerConnection.signalingState?this.handleRelease():(this.myPeerConnection.getSenders().forEach(t=>{e.myPeerConnection.removeTrack(t)}),this.myPeerConnection.close(),setTimeout(()=>{null!=e.myPeerConnection&&"closed"==e.myPeerConnection.signalingState&&e.handleRelease()},100))),this.videoplaying=!1,this.RTCPeerConnectionCreated=!1,this.StartCalled=!1,this.IceCandidate.splice(0,this.IceCandidate.length)},handleRelease(){console.log("handleRelease  ========"),null!=this.myPeerConnection&&(this.myPeerConnection.onicecandidate=null,this.myPeerConnection.onaddstream=null,this.myPeerConnection.ontrack=null,this.myPeerConnection.onsignalingstatechange=null,this.myPeerConnection.onicegatheringstatechange=null,this.myPeerConnection=null),0==this.IsFailCreate&&(this.IsReconnect=!0),window.localStream=null,this.stream=null},async handleAnswner(e){var t=this;console.log("  setRemoteDescription --------");var n=window.mozRTCSessionDescription||window.RTCSessionDescription,s=new n({type:"answer",sdp:e.sdp});await this.myPeerConnection.setRemoteDescription(s).then((function(){t.canAddIceCandidate=!0,t.IceCandidate.forEach(e=>{console.log(" add addIceCandidate --------------",e.candidate);var n=new RTCIceCandidate({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate});t.myPeerConnection.addIceCandidate(n)}),t.IceCandidate.splice(0,t.IceCandidate.length)}),(function(e){console.log("  setRemoteDescription --------error:"+e)}))},async handleOffer(e){this.IsReconnect=!1;var t=this;if(console.log("handleCall --offer- ----",e),this.sessionId=e.sessionId,null===e.iceservers&&void 0===e.iceservers&&""===e.iceservers||(this.configuration=JSON.parse(e.iceservers),console.log("WebSocket iceServers  --",this.configuration)),0==this.RTCPeerConnectionCreated&&this.initPeerConnection(),0==this.RTCPeerConnectionCreated)console.log("handleOffer Failed   RTCPeerConnectionCreated = ",this.RTCPeerConnectionCreated),this.sendDisconnect(),this.IsReconnect=!1,this.IsFailCreate=!0;else{let s=window.mozRTCSessionDescription||window.RTCSessionDescription;var n=new s({type:"offer",sdp:e.sdp});await this.myPeerConnection.setRemoteDescription(n).then((function(){t.canAddIceCandidate=!0,t.IceCandidate.forEach(e=>{console.log(" add addIceCandidate --------------",e.candidate);var n=new RTCIceCandidate({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate});t.myPeerConnection.addIceCandidate(n)}),t.IceCandidate.splice(0,t.IceCandidate.length)}),(function(e){console.log("  setRemoteDescription --------error:"+e)})),this.Call(),this.$store.state.statename="通话中",this.mute=!0,this.setlocalspeak(),await this.myPeerConnection.createAnswer().then((function(n){t.myPeerConnection.setLocalDescription(n),console.log("Answer sdp :\n"+n.sdp),t.sendToServer({eventName:"__answer",data:{sessionId:e.sessionId,sessionType:"IE",messageId:t.newGuid(),from:e.to,to:e.from,type:n.type,sdp:n.sdp}})})).catch((function(e){console.log("Error when create  Answer-----------------------------",e.message),t.sendDisconnect(),t.IsReconnect=!0,this.IsFailCreate=!0}))}},async handleCall(e){this.IsReconnect=!1;var t=this;this.sessionId=e.sessionId,null===e.iceservers&&void 0===e.iceservers&&""===e.iceservers||(this.configuration=JSON.parse(e.iceservers)),0==this.RTCPeerConnectionCreated&&this.initPeerConnection(),0==this.RTCPeerConnectionCreated?(console.log("handleOffer Failed   RTCPeerConnectionCreated = ",this.RTCPeerConnectionCreated),this.sendDisconnect(),this.IsReconnect=!1,this.IsFailCreate=!0):await this.myPeerConnection.createOffer().then((function(n){t.myPeerConnection.setLocalDescription(n).then((function(){t.sendToServer({eventName:"__offer",data:{sessionId:t.sessionId,sessionType:"IE",messageId:t.newGuid(),from:t.meid,to:t.peerid,type:n.type,sdp:n.sdp,mode:"live",source:"MainStream",datachannel:"true",audio:"sendrecv",video:"sendrecv",user:"admin",pwd:"123456",iceservers:e.iceServers}})}),(function(e){console.log("  setLocalDescription --------error "+e)}))})).catch((function(e){console.log("Error when create  offer-----------------------------",e.message),t.sendDisconnect(),t.IsReconnect=!0,this.IsFailCreate=!0}))},sendDisconnect(){this.sendToServer({eventName:"__disconnected",data:{sessionId:this.sessionId,sessionType:"IE",messageId:this.newGuid(),from:this.meid,to:this.peerid}})},async handleCandidate(e){console.log("----handleCandidate-data：",e,e.candidate);var t={};try{t=JSON.parse(e.candidate)}catch(s){t={candidate:e.candidate,sdpMLineIndex:e.label,sdpMid:e.label},console.log("----handleCandidate-data-erro to：",t)}if(null!=this.myPeerConnection&&1==this.RTCPeerConnectionCreated&&1==this.canAddIceCandidate){var n=new RTCIceCandidate({sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate});await this.myPeerConnection.addIceCandidate(n).then((function(){console.log(" IceCandidate  sucessed")}),(function(e){console.log("add IceCandidate error:",+e)}))}else console.log("handleCandidate add to tmp IceCandidate",t),this.IceCandidate.push(t)},initPeerConnection(){try{if(this.myPeerConnection=new RTCPeerConnection(this.configuration),null!=this.myPeerConnection){if("addTrack"in this.myPeerConnection?null!=this.stream?this.stream.getTracks().forEach(e=>{this.myPeerConnection.addTrack(e,this.stream),console.log("PeerConnection use addTrack type",e.kind),"audio"===e.kind&&(e.enabled=!0)}):console.log("PeerConnection  addTrack  stream is null"):null!=this.stream?(this.myPeerConnection.addStream(this.stream),this.stream.getTracks().forEach(e=>{console.log("PeerConnection use addStream type",e.kind),"audio"===e.kind&&(e.enabled=!0)})):console.log("PeerConnection  addStream is null"),"ontrack"in this.myPeerConnection?this.myPeerConnection.ontrack=this.handleRemoteTrackAdded:this.myPeerConnection.onaddstream=this.handleRemoteStreamAdded,this.myPeerConnection.onicecandidate=this.handleIceCandidate,this.myPeerConnection.oniceconnectionstatechange=this.handleIceConnectionStateChangeEvent,this.myPeerConnection.onicegatheringstatechange=this.handleIceGatheringStateChangeEvent,this.myPeerConnection.onsignalingstatechange=this.handleSignalingStateChangeEvent,1==this.IsLocalDataChannel)try{this.myDataChannel=this.myPeerConnection.createDataChannel("mydatachannel"),this.myDataChannel&&(this.myDataChannel.onopen=this.handleDataChannelOnOpen,this.myDataChannel.onclose=this.handleDataChannelOnClose,this.myDataChannel.onmessage=this.handleDataChannelOnMessage,this.myDataChannel.onerror=this.handleDataChannelOnError)}catch(e){console.log("data_channel_create_error  ")}console.log("Sucessed to create PeerConnection"),this.RTCPeerConnectionCreated=!0}else console.log("Failed to create PeerConnection"),this.RTCPeerConnectionCreated=!1}catch(t){return console.log("Failed to create PeerConnection, exception: "+t.message),void(this.RTCPeerConnectionCreated=!1)}},getObjectURL(e){var t=null;try{void 0!=window.createObjectURL?(t=window.createObjectURL(e),console.log("window createObjectURL",t)):void 0!=window.URL?(t=window.URL.createObjectURL(e),console.log("window window.URLcreateObjectURL ",t)):void 0!=window.webkitURL&&(t=window.webkitURL.createObjectURL(e),console.log("window.webkitURL.createObjectURL ",t))}catch(n){t=null}return t},handleRemoteTrackAdded(e){this.remoteMediaStream=e.streams[0],null!=this.remoteVideo?(e.streams[0].getTracks().forEach(e=>{"audio"===e.kind&&(e.enabled=!0)}),this.remoteVideo.srcObject=e.streams[0],0==this.IsSystemAudioDeviceOK&&(this.remoteVideo.muted=!1)):console.log("handleRemoteTrackAdded  video view is null")},handleRemoteStreamAdded(e){if(this.remoteMediaStream=e.stream,null!=this.remoteVideo)if("srcObject"in this.remoteVideo)console.log("handleRemoteStreamAdded attachStream srcObject stream id = ",e.stream.id),this.remoteVideo.srcObject=e.stream,e.stream.getTracks().forEach(e=>{console.log("handleRemoteTrackAdded  ",e),"audio"===e.kind&&(e.enabled=!0)});else{var t=this.getObjectURL(e.stream);console.log("handleRemoteStreamAdded attachStream getObjectURL stream id = ",e.stream.id),this.remoteVideo.src=t,e.stream.getTracks().forEach(e=>{console.log("handleRemoteTrackAdded  ",e),"audio"===e.kind&&(e.enabled=!0)})}},handleIceCandidate(e){e.candidate&&this.sendToServer({eventName:"__ice_candidate",data:{sessionId:this.sessionId,sessionType:"IE",messageId:this.newGuid(),to:this.peerid,from:this.meid,candidate:JSON.stringify({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex})}})},handleIceConnectionStateChangeEvent(e){if(null!=this.myPeerConnection&&(console.log("*** ICE connection state changed to "+this.myPeerConnection.iceConnectionState,e),e.target==this.myPeerConnection))switch(console.log("*** ICE connection state changed to ",e.target.iceConnectionState),this.myPeerConnection.iceConnectionState){case"closed":this.handleRelease();break;case"failed":case"disconnected":1==this.RTCPeerConnectionCreated&&(this.handleLeave(),this.sendDisconnect());break;case"connected":this.videoplay();break}},handleIceGatheringStateChangeEvent(e){null!=this.myPeerConnection&&e.target==this.myPeerConnection&&console.log("*** ICE gathering state changed to: "+e.target.iceGatheringState)},handleSignalingStateChangeEvent(e){if(null!=this.myPeerConnection&&e.target==this.myPeerConnection)switch(console.log("*** WebRTC signaling state changed to: "+e.target.signalingState),this.myPeerConnection.signalingState){case"closed":this.handleLeave();break}},handleDataChannelOnOpen(){console.log("handleDataChannelOnOpen"),this.myDataChannel&&this.myDataChannel.send(JSON.stringify({title:"siren",sequence:0,payload:{alarm_audio:!0}}))},handleDataChannelOnClose(e){console.log("handleDataChannelOnClose ---------",e)},handleDataChannelOnMessage(e){var t;console.log("handleDataChannelOnMessage ",e),t=JSON.parse(e.data),"__file"===t.type||t.type,console.log("handleDataChannelOnMessage recive message data",t.data)},handleDataChannelOnError(e){console.log("handleDataChannelOnError ",e)},close(){this.socketTask&&this.socketTask.close&&this.socketTask.close()},newGuid(){let e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return(e()+e()+"-"+e()+"-4"+e().substr(0,3)+"-"+e()+"-"+e()+e()+e()).toUpperCase()},streamHandler(e){this.CheckedgetUserMedia=!0,this.stream=e,console.log("streamHandler  stream = ",this.stream),"getTracks"in e&&null!=e&&e.getTracks().forEach(e=>{"audio"===e.kind?(this.wpvideocall(),this.IsLocalAudioTrack=!0):"video"===e.kind&&(this.$store.state.ability<1?e.stop():this.IsLocalVideoTrack=!0)}),0==this.StartCalled&&this.IsWebSocketCreateed},errorHandler(e){console.log("errorHandler",e),this.CheckedgetUserMedia=!0,0==this.StartCalled&&this.IsWebSocketCreateed},videoplay(){var e=this;if(0==this.videoplaying){this.videoplaying=!0;var t=this.remoteVideo.play();t&&t.then(()=>{e.videoplaying=!0,console.log("<video>  play")}).catch(t=>{e.videoplaying=!1,console.log("<video> play error",t.message)})}},OnVideoPlay(){console.log("<video> event OnVideoPlay------")},OnVideoLoadedMetaData(){console.log("<video> event OnVideoLoadedMetaData----------------"),this.videoplay()},OnVideoCanPlay(){console.log("<video>  OnVideoCanPlay-----videoWidth = "+this.remoteVideo.videoWidth),console.log("<video>  OnVideoCanPlay-----videoHeight = "+this.remoteVideo.videoHeight),console.log("<documentElement>  OnVideoCanPlay------clientWidth = "+document.documentElement.clientWidth),console.log("<documentElement>  OnVideoCanPlay------clientHeight = "+document.documentElement.clientHeight);var e=document.getElementById("loading");null!=e&&(e.style.display="none");var t=document.getElementById("canvas");null!=t&&(t.style.width=this.remoteVideo.videoWidth,t.style.height=this.remoteVideo.videoHeight);var n=document.getElementById("videos");null!=n&&(n.style.width="100%"),this.$store.state.ability<1&&(n.style.display="none");var s=document.documentElement.clientWidth*this.remoteVideo.videoHeight/this.remoteVideo.videoWidth;s>document.documentElement.clientHeight&&this.isIos,null!=n&&console.log("<video>----------------height "+n.style.height),1==this.remoteVideo.muted?(0==this.isIos&&(this.remoteVideo.muted=!1),console.log("<video>----------------muted = true")):console.log("<video>----------------muted = false")},OnVideoError(){console.log("<video> event OnVideoError----------------")},OnVideoLoadedData(){console.log("<video> event OnVideoLoadedData----------------")}}},I=k,S=(n("8f6f"),n("2877")),P=Object(S["a"])(I,a,r,!1,null,"646d0309",null),M=P.exports,L=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"keyboard-wrapper"},[n("img",{staticClass:"logo",attrs:{src:e.imgsrclogo}}),this.$store.state.isclose?e._e():n("div",{directives:[{name:"show",rawName:"v-show",value:e.isShowdiv,expression:"isShowdiv"}],attrs:{id:"showdiv"}},[n("p",[n("b",[e._v(e._s(e.initstate))])]),n("input",{directives:[{name:"model",rawName:"v-model",value:e.NUM,expression:"NUM"}],attrs:{id:"telinput",type:"text",onfocus:"this.blur()",placeholder:"输入房间号(单元号+房号如0808/010808)或电话"},domProps:{value:e.NUM},on:{focus:function(t){e.show=!0},input:function(t){t.target.composing||(e.NUM=t.target.value)}}}),n("div",{staticClass:"keyboard"},[n("div",{directives:[{name:"show",rawName:"v-show",value:e.hasmanage,expression:"hasmanage"}],staticClass:"callmanage",attrs:{id:"manageto"},on:{click:e.callmanege}},[e._v("呼叫物业")]),n("div",{directives:[{name:"show",rawName:"v-show",value:!e.isShowSelect,expression:"!isShowSelect"}],staticClass:"num",attrs:{id:"keybd"}},[n("table",[n("tr",[n("td",{class:[1===e.active?"active":""],on:{click:function(t){return e.change(1)},touchstart:function(t){return e.msDown(1)},touchend:function(t){return e.msUp(1)}}},[e._v(" 1 ")]),n("td",{class:[2===e.active?"active":""],on:{click:function(t){return e.change(2)},touchstart:function(t){return e.msDown(2)},touchend:function(t){return e.msUp(2)}}},[e._v(" 2 ")]),n("td",{class:[3===e.active?"active":""],on:{click:function(t){return e.change(3)},touchstart:function(t){return e.msDown(3)},touchend:function(t){return e.msUp(3)}}},[e._v(" 3 ")])]),n("tr",[n("td",{class:[4===e.active?"active":""],on:{click:function(t){return e.change(4)},touchstart:function(t){return e.msDown(4)},touchend:function(t){return e.msUp(4)}}},[e._v(" 4 ")]),n("td",{class:[5===e.active?"active":""],on:{click:function(t){return e.change(5)},touchstart:function(t){return e.msDown(5)},touchend:function(t){return e.msUp(5)}}},[e._v(" 5 ")]),n("td",{class:[6===e.active?"active":""],on:{click:function(t){return e.change(6)},touchstart:function(t){return e.msDown(6)},touchend:function(t){return e.msUp(6)}}},[e._v(" 6 ")])]),n("tr",[n("td",{class:[7===e.active?"active":""],on:{click:function(t){return e.change(7)},touchstart:function(t){return e.msDown(7)},touchend:function(t){return e.msUp(7)}}},[e._v(" 7 ")]),n("td",{class:[8===e.active?"active":""],on:{click:function(t){return e.change(8)},touchstart:function(t){return e.msDown(8)},touchend:function(t){return e.msUp(8)}}},[e._v(" 8 ")]),n("td",{class:[9===e.active?"active":""],on:{click:function(t){return e.change(9)},touchstart:function(t){return e.msDown(9)},touchend:function(t){return e.msUp(9)}}},[e._v(" 9 ")])]),n("tr",[n("td",{staticClass:"del",on:{click:e.del}},[e._v("←")]),n("td",{class:[0===e.active?"active":""],on:{click:function(t){return e.change(0)},touchstart:function(t){return e.msDown(0)},touchend:function(t){return e.msUp(0)}}},[e._v(" 0 ")]),n("td",{staticClass:"comfirm",attrs:{id:"comfirm"},on:{click:e.comfirm}},[e._v("确定")])])])]),n("div",{directives:[{name:"show",rawName:"v-show",value:e.isShowSelect,expression:"isShowSelect"}],staticClass:"selectperson"},[n("h3",{staticClass:"F7"},[e._v("请选择呼叫对象")]),n("div",{staticClass:"por"},[n("div",{staticClass:"selectBox",staticStyle:{width:"100%"}},[n("input",{directives:[{name:"model",rawName:"v-model",value:e.unitModel,expression:"unitModel"}],attrs:{type:"hidden",name:"unit"},domProps:{value:e.unitModel},on:{input:function(t){t.target.composing||(e.unitModel=t.target.value)}}}),n("div",{staticClass:"selectBox_list"},e._l(e.dataList,(function(t,s){return n("div",{key:s,staticClass:"selectBox_listLi",on:{click:function(n){return n.stopPropagation(),e.select(t,s)}}},[e._v(e._s(t.realName)+"("+e._s(t.encryptPhone)+") ")])})),0)])])])]),n("div",{staticClass:"okto",attrs:{id:"okto"},on:{click:e.comfirm}},[e._v("呼叫")])]),this.$store.state.isclose?n("div",{staticClass:"showclose"},[n("center",[n("br"),n("p",[n("b",{staticStyle:{color:"green"}},[e._v("呼叫通话已结束")])]),n("br"),3==this.$store.state.actype?n("div",{directives:[{name:"show",rawName:"v-show",value:!e.isShowdiv,expression:"!isShowdiv"}]},[n("p",[e._v("关注小程序“小乐开门“")]),n("p",[e._v("苹果手机建议使用App:"),n("a",{attrs:{href:"https://www.yhxaiot.com/downapp.html"}},[n("span",[e._v("下载App")])])]),n("br"),n("p",[e._v("使用“小乐开门”小程序或App重新扫码进行设备绑定！")])]):e._e()])],1):e._e()])},O=[],R=n("cf05"),E=n.n(R),T=n("8940"),U=n.n(T);const x=n("bc3a");var D={name:"Start",data(){return{imgsrclogo:E.a,imgxcxlogo:U.a,active:null,show:!1,NUM:"",result:[],deviceid:"",isShowSelect:!1,isShowdiv:!1,hasmanage:!1,managephone:"",talkTime:1,dataList:[],unitName:"请选择对象"}},computed:{num:function(){return this.result.join("")},initstate(){return this.$store.state.callinfo.doorname}},created(){},mounted(){if(this.$store.state.isclose)return!1;var e=this.getQueryString("v");if(null==e||""==e)return alert("设备参数错误"),!1;this.deviceid=e;var t=this.getQueryString("ability");null!=t&&t>=0&&(this.$store.state.ability=t);var n=this.getQueryString("doorname");null!=n&&(n=decodeURI(this.getQueryVariable("doorname")),document.title=n,this.$store.state.callinfo.doorname=n),this.setOnekeycall(this.getQueryString("to")),this.getunitinfo()},methods:{msDown(e){this.active=e},msUp(e){this.active="",console.log(e)},stopInput(){return!1},change(e){if(0===this.result.length&&"."===e)return!1;this.result.push(e),this.NUM=this.result.join("")},del(){this.result.pop(),this.NUM=this.result.join(""),this.$emit("del",this.NUM)},getQueryString(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=new RegExp("(^|/)"+e+"/([^/]*)(/|$)","i"),s=window.location.search.substr(1).match(t),i=window.location.pathname.substr(1).match(n);return null!=s?unescape(s[2]):null!=i?unescape(i[2]):null},getQueryVariable(e){for(var t=window.location.search.substring(1),n=t.split("&"),s=0;s<n.length;s++){var i=n[s].split("=");if(i[0]==e)return i[1]}return!1},async getToken(e){var t={username:"admin",password:"yhx2023!"};x({method:"post",url:"/login",baseURL:this.$store.state.callinfo.remoteurl,headers:{"Access-Control-Allow-Origin":"*"},data:t,params:t}).then(t=>(console.log("get-token",t.data),200==t.data.code?(this.$store.state.accesstoken=t.data.token,console.log("--token",this.$store.state.accesstoken),e()):void alert(t.data.msg))).catch(e=>{console.log(e)})},getunitinfo(){var e={et:this.deviceid};x({method:"get",url:"/wechat/init",baseURL:this.$store.state.callinfo.remoteurl,headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json",token:this.$store.state.accesstoken},data:e,params:e}).then(e=>{if(console.log("get-appid",e.data),200!=e.data.retCode)return alert(e.data.message),this.showerrodiv();var t=e.data.data.ne;if(document.title=t,this.$store.state.callinfo.doorname=t,this.$store.state.talkTime=e.data.data.confine,""!=e.data.data.logo&&(this.imgsrclogo=e.data.data.logo+"?r=10"),this.$store.state.deviceId=this.deviceid,""!=e.data.data.ets&&(this.device_id=e.data.data.ets,this.$store.state.deviceId=this.device_id),""!=e.data.data.server&&(this.$store.state.callinfo.server=e.data.data.server),""!=e.data.data.baseurl&&(this.$store.state.callinfo.remoteurl=e.data.data.baseurl),""!=e.data.data.useType&&(this.$store.state.actype=e.data.data.useType),null!=e.data.data.status&&1!=e.data.data.status)return alert("设备未授权，请使用小程序或app扫码激活！"),this.$store.state.isclose=!0,this.showerrodiv(1);""!=e.data.data.phone&&this.setOnekeycall(e.data.data.phone),null!=e.data.data.manage&&""!=e.data.data.manage.phone&&(this.$store.state.callinfo.roomtel="管理中心",this.$store.state.callinfo.doorname="管理中心",this.hasmanage=!0,this.managephone=e.data.data.manage.phone),this.isShowdiv=!0}).catch(e=>{console.log(e)})},comfirm(){var e=this.getQueryString("key");if(null!=e&&""!=e&&(this.$store.state.callinfo.meid=e,this.$store.state.callinfo.doorname="测试单元 "),""!=this.NUM)if(this.$store.state.isclose)alert("呼叫已关闭，请重新扫码进入！");else{var t=/^[1][3,4,5,6,7,8,9][0-9]{9}$/,n=/^(?:\d{4}|\d{6}|\d{8})$/;if(3!=this.NUM.length&&5!=this.NUM.length&&7!=this.NUM.length||(this.NUM="0"+this.NUM),t.test(this.NUM)||n.test(this.NUM)){this.$emit("comfirm",this.NUM),this.show=!1;var s=document.getElementById("comfirm");s.style.display="none";var i={et:this.$store.state.deviceId,number:this.NUM};x({method:"post",url:"/wechat/table",baseURL:this.$store.state.callinfo.remoteurl,headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json",token:this.$store.state.accesstoken},data:i,params:i}).then(e=>{if(console.log("phone-call return",i,e.data),200==e.data.retCode&&(this.$store.state.callinfo.meid=e.data.data.licence,this.$store.state.callinfo.roomtel=this.NUM,""!=e.data.data.phoneList&&null!=e.data.data.phoneList?(this.isShowSelect=!0,this.dataList=e.data.data.phoneList):(this.$store.state.callinfo.phone=e.data.data.phone,this.$store.state.callinfo.peerid=e.data.data.phone,this.$store.state.login=!0)),400==e.data.retCode)return alert(e.data.message),this.showerrodiv()}).catch(e=>{console.log(e)})}else alert("输入非法")}},callmanege(){this.NUM=this.managephone,this.setOnekeycall(this.managephone),this.comfirm(),this.$store.state.callinfo.roomtel="物业",this.$store.state.callinfo.doorname="物业"},select(e,t){this.isShowSelect=!1;var n=this.dataList[t].phone,s=this.dataList[t].phone;(""!=this.dataList[t].deviceLicence&&null!=this.dataList[t].deviceLicence||void 0!=this.dataList[t].deviceLicence)&&(s=this.dataList[t].deviceLicence),this.unitModel=t,this.unitName=n,Object.keys(this.dataList[t]).includes("isVideo")&&!1===this.dataList[t].isVideo&&(this.$store.state.callinfo.isvideo=!1),this.$store.state.callinfo.phone=n,this.$store.state.callinfo.peerid=s,this.$store.state.login=!0},setOnekeycall(e){if(null!=e&&e>=0){var t=document.getElementById("keybd"),n=document.getElementById("telinput"),s=document.getElementById("okto");null!=n&&(n.style.display="none"),null!=t&&(t.style.display="none"),s.style.display="block",this.NUM=e}},showerrodiv(e){var t=document.getElementById("keybd"),n=document.getElementById("telinput");n.style.display="none",t.style.display="none",1==e&&(this.imgsrclogo=E.a,this.isShowdiv=!1)}}},V=D,W=(n("a8ff"),Object(S["a"])(V,L,O,!1,null,"dc8be2ca",null)),N=W.exports,_={name:"App",components:{HelloWorld:M,Start:N},data(){return{show:!1}},computed:{listenshow(){return this.$store.state.login}}},j=_,H=(n("034f"),Object(S["a"])(j,i,o,!1,null,null,null)),B=H.exports,$=n("2f62");s["a"].use($["a"]);const J=new $["a"].Store({state:{accesstoken:"eyJhbGciOiJIUzUxMiJ9.eyJsb2dpbl91c2VyX2tleSI6IjMwMTdjOWYyLWIyZDUtNDg2Zi05YTM1LTdlMTM4MzRkNjUyMCJ9.YMlUHqyLW6wXHzdk4kQ4Pu4gl-THXUCnmkXocVfbuzl3SujL7I6XFj8NbcXcGWZ1sreBoMbvevnXhfdFZ3O2wA",deviceId:"0",ability:1,actype:2,login:!1,isvideo:!0,isclose:!1,statename:"准备",roomtel:"",callinfo:{meid:"",peerid:"",server:"rtcsv.yhxaiot.com",doorname:"",phone:"",remoteurl:"https://call.yhxaiot.com/community"}}});var F=J;s["a"].config.productionTip=!1,new s["a"]({el:"#app",store:F,render:e=>e(B)}).$mount("#app")},"57b9":function(e,t,n){e.exports=n.p+"static/img/hangup.31ab348b.png"},5883:function(e,t,n){e.exports=n.p+"static/img/ic_video_unlock_land.c56b7fdb.png"},"85ec":function(e,t,n){},8940:function(e,t,n){e.exports=n.p+"static/img/xcxlogo.93f01924.jpg"},"8f6f":function(e,t,n){"use strict";n("4bf8")},a8ff:function(e,t,n){"use strict";n("db3a")},a92e:function(e,t,n){e.exports=n.p+"static/img/ic_video_stop.849dd6c5.png"},c5d3:function(e,t,n){e.exports=n.p+"static/img/ic_video_record.a97f9d4a.png"},ce44:function(e,t,n){e.exports=n.p+"static/img/ic_video_stop_land.c4a06951.png"},cf05:function(e,t,n){e.exports=n.p+"static/img/logo.fc03c209.png"},cf7d:function(e,t,n){e.exports=n.p+"static/img/ic_video_unlock.7251968c.png"},db3a:function(e,t,n){}});
//# sourceMappingURL=app.d4738b0c.js.map